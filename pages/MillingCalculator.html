<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Milling Calculator v4.4 — Blue & White Industrial</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --blue:#3498db; --blue-2:#2b9ae0; --green:#2ecc71;
      --bg:#f5f7fa; --panel:#ffffff; --text:#23303a; --muted:#6b7785; --border:#e3e8ee;
      --shadow:0 3px 8px rgba(0,0,0,0.08); --soft-shadow:0 6px 18px rgba(43,154,224,0.08);
      --radius:12px;
    }
    *{box-sizing:border-box}
    html,body{height:120%;margin:0;padding:0}
    body{
      font-family:Inter,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text);
      padding:28px; display:flex; justify-content:center;
    }
    .app{
      width:100%; max-width:1150px; border-radius:14px; padding:18px;
      background:var(--panel); box-shadow:var(--shadow); border:1px solid var(--border);
    }
    header{display:flex; gap:14px; align-items:center; margin-bottom:22px}
    .logo{width:56px;height:56px;border-radius:12px;overflow:hidden; display:flex;align-items:center;justify-content:center}
    .logo img{width:100%;height:100%;object-fit:cover}
    .title h1{margin:0;font-size:1.35rem;color:var(--blue)}
    .title p{margin:2px 0 0;color:var(--muted);font-size:0.9rem}
    .layout{display:grid;grid-template-columns:1fr 420px;gap:20px}
    @media(max-width:980px){.layout{grid-template-columns:1fr}}
    .panel{background:var(--panel);border-radius:12px;padding:20px;border:1px solid var(--border);box-shadow:var(--soft-shadow)}
    .modes{display:flex;gap:10px;margin-bottom:18px}
    .mode-btn{
      flex:1;padding:12px;border-radius:10px;border:2px solid var(--blue);background:var(--panel);
      cursor:pointer;color:var(--blue);font-weight:700;display:flex;align-items:center;justify-content:center;gap:8px;
      transition:all .15s;
    }
    .mode-btn.active{background:linear-gradient(90deg,var(--blue),var(--blue-2));color:#fff;transform:translateY(-2px);box-shadow:0 8px 26px rgba(43,154,224,0.06)}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px}
    @media(max-width:600px){.grid-2{grid-template-columns:1fr}}
    label{display:block;font-size:0.86rem;color:var(--muted);margin-bottom:6px;font-weight:700}
    input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--text);font-size:1rem}
    input::placeholder{color:rgba(35,48,58,0.35)}
    .controls{display:flex;gap:10px;margin-top:14px}
    .btn-primary{flex:1;padding:12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--blue),var(--blue-2));color:white;font-weight:800;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px}
    .btn-secondary{padding:12px;border-radius:10px;border:1px solid var(--blue);background:var(--panel);color:var(--blue);font-weight:700;cursor:pointer}
    .btn-secondary:hover{background:var(--blue);color:#fff}
    .note{font-size:0.9rem;color:var(--muted);margin-top:14px;line-height:1.4}
    .side{display:flex;flex-direction:column;gap:16px}
    .card{background:var(--panel);padding:16px;border-radius:12px;border:1px solid var(--border);box-shadow:var(--shadow)}
    .kpi{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .meta{display:flex;gap:12px;align-items:center}
    .meta .ic{width:54px;height:54px;border-radius:12px;background:linear-gradient(135deg,var(--blue),var(--blue-2));display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:1.3rem}
    .result-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    @media(max-width:600px){.result-grid{grid-template-columns:1fr}}
    .box-blue{background:linear-gradient(180deg,rgba(52,152,219,0.08),rgba(52,152,219,0.03));padding:12px;border-radius:10px}
    .box-green{background:linear-gradient(180deg,rgba(46,204,113,0.08),rgba(46,204,113,0.03));padding:12px;border-radius:10px}
    .big{font-size:1.9rem;font-weight:900;color:var(--text)}
    .muted{color:var(--muted)}
    .ok{color:var(--green);font-weight:700}
    .warn{color:#ff8a00;font-weight:800}
    .formula{margin-top:14px;color:var(--muted);font-size:0.92rem;background:#f9fbff;padding:12px;border-radius:10px;border:1px solid var(--border)}
    .small{font-size:0.88rem;color:var(--muted)}
  </style>
</head>
<body>
  <div class="app" aria-label="Milling Calculator v4.4">
    <header>
      <div class="logo"><img src="CS.png" alt="Company Logo"></div>
      <div class="title">
        <h1>Milling Calculator v4.4 — Blue & White Industrial</h1>
        <p>Endmill · Drill · Slotmill — Material-Based Speed & Feed Guidance</p>
      </div>
    </header>

    <main class="layout">
      <section class="panel" aria-labelledby="inputs">
        <div>
          <strong id="inputs">Inputs</strong>
          <div class="small" style="margin-top:4px">Choose tool type & material — use Suggest to auto-fill conservative starting values.</div>
        </div>

        <div class="modes" style="margin-top:12px">
          <button class="mode-btn active" data-mode="endmill"><i class="fa-solid fa-cut"></i> Endmill</button>
          <button class="mode-btn" data-mode="drill"><i class="fa-solid fa-drill"></i> Drill</button>
          <button class="mode-btn" data-mode="slot"><i class="fa-solid fa-slash"></i> Slotmill</button>
        </div>

        <div class="grid-2">
          <div>
            <label for="toolMat">Tool Material</label>
            <select id="toolMat">
              <option value="carbide">Carbide</option>
              <option value="hss">HSS</option>
              <option value="coated">Coated Carbide</option>
            </select>
          </div>
          <div>
            <label for="workMat">Work Material</label>
            <select id="workMat">
              <option value="mild_steel">Mild Steel</option>
              <option value="Alloy Steel">Alloy Steel</option>
              <option value="stainless">Stainless Steel</option>
              <option value="aluminum">Aluminium</option>
              <option value="brass">Brass</option>
              <option value="plastic">Plastic</option>
              <option value="SuperAlloy">SuperAlloy</option>
            </select>
          </div>
        </div>

        <div class="grid-2">
          <div>
            <label for="Vc">Cutting Speed Vc (m/min)</label>
            <input id="Vc" placeholder="Auto-suggested — editable">
            <div id="vcRange" class="small" style="margin-top:6px">Suggestion will appear after selection</div>
          </div>
          <div>
            <label for="D">Tool Diameter D (mm)</label>
            <input id="D" placeholder="e.g. 20">
          </div>
        </div>

        <div class="grid-2">
          <div>
            <label for="n">Spindle Speed n (rpm)</label>
            <input id="n" placeholder="Leave empty to auto-calc">
          </div>
          <div>
            <label for="Vf">Feed Vf (mm/min)</label>
            <input id="Vf" placeholder="Table feed">
          </div>
        </div>

        <div class="grid-2">
          <div>
            <label id="fzLabel" for="fz">Feed per Tooth fz (mm/tooth)</label>
            <input id="fz" placeholder="mm/tooth (drill: mm/rev)">
            <div id="fzRange" class="small" style="margin-top:6px"></div>
          </div>
          <div id="zWrap">
            <label for="Z">Number of Flutes (Z)</label>
            <input id="Z" placeholder="e.g. 4">
          </div>
        </div>

        <div class="controls">
          <button id="calcBtn" class="btn-primary"><i class="fa-solid fa-calculator"></i> Calculate</button>
          <button id="suggestBtn" class="btn-secondary"><i class="fa-solid fa-lightbulb"></i> Suggest</button>
          <button id="resetBtn" class="btn-secondary"><i class="fa-solid fa-rotate"></i> Reset</button>
        </div>

  
        <div class="formula">
          <strong>Formulas</strong>
          <div style="margin-top:6px">Vc = (π × D × n) / 1000</div>
          <div>n = (Vc × 1000) / (π × D)</div>
          <div>Vf = n × fz × Z  (milling)</div>
          <div>Vf = n × f  (drilling)</div>
        </div>
      </section>

      <aside class="side">
        <div class="card">
          <div class="kpi">
            <div class="meta">
              <div class="ic" id="modeIcon"><i class="fa-solid fa-cut"></i></div>
              <div class="txt">
                <div class="label" id="modeTitle">Endmill</div>
                <div class="sub" id="modeSub">fz × Z used for feed</div>
              </div>
            </div>
          </div>

          <div class="result-grid">
            <div class="box-blue">
              <div class="muted">Spindle Speed (n)</div>
              <div class="big" id="outN">- rpm</div>
            </div>

            <div class="box-green">
              <div class="muted">Feed (Vf)</div>
              <div class="big" id="outVf">- mm/min</div>
            </div>
          </div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
            <div id="calcMsg" class="muted">Awaiting input...</div>
            <div style="display:flex;gap:8px">
              <button id="copyRes" class="btn-secondary"><i class="fa-regular fa-clipboard"></i> Copy</button>
              <button id="exportCsv" class="btn-secondary"><i class="fa-solid fa-file-csv"></i> Export</button>
            </div>
          </div>
        </div>

        <div class="card">
          <strong>Material Tips</strong>
          <div id="advTips" class="small" style="margin-top:8px"></div>
          <div class="small" style="margin-top:10px;color:var(--muted)">
            Example conservative ranges (for reference)
            <ul style="margin:8px 0 0 18px;color:var(--muted)">
              <li>Mild Steel — Vc 80–140 m/min, fz 0.02–0.06</li>
              <li>Alloy Steel / CR — Vc 80–130 m/min, fz 0.015–0.05</li>
              <li>Stainless — Vc 60–100 m/min, fz 0.02–0.05</li>
              <li>Aluminium — Vc 200–380 m/min, fz 0.04–0.12</li>
              <li>Brass — Vc 120–220 m/min, fz 0.03–0.08</li>
              <li>Plastic — Vc 150–300 m/min, fz 0.05–0.15</li>
              <li>Inconel — Vc 18–30 m/min, fz 0.01–0.04</li>
            </ul>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <script>
    /*******************************
     Milling Calculator v4.4
     - preserves original calculation logic
     - improved suggest fallback handling
     - removed unused UI controls per request
    *******************************/

    const PI = 3.14159;

    // Presets sourced from earlier v4.2 — conservative starting ranges
    const presets = {
      endmill: {
        carbide: {
          mild_steel: {vc:[100,160], fz:[0.02,0.06], tips: "Carbide endmill - use coolant for deep cuts."},
          'Alloy Steel':     {vc:[80,130],  fz:[0.015,0.05], tips: "Alloy Steel: higher strength — consider lower fz for roughing."},
          stainless:  {vc:[60,100],  fz:[0.02,0.05], tips: "Stainless: lower speed, maintain coolant."},
          aluminum:   {vc:[250,380], fz:[0.04,0.12], tips: "Aluminum: higher speeds, ensure chip evacuation."},
          brass:      {vc:[120,220], fz:[0.03,0.08], tips: "Brass: lower forces, avoid built-up edge."},
          plastic:    {vc:[180,300], fz:[0.05,0.15], tips: "Plastic: reduce heat; prefer climb milling."},
          SuperAlloy:    {vc:[18,30],   fz:[0.01,0.04], tips: "SuperAlloy: very low Vc and low fz; use coolant, short engagement."}
        }
      },
      drill: {
        carbide: {
          mild_steel: {vc:[80,140], f:[0.08,0.18], tips: "Carbide drills: peck drill for deep holes."},
          'Alloy Steel':     {vc:[60,120], f:[0.06,0.15], tips: "Use coolant and pecking cycles."},
          stainless:  {vc:[30,60],  f:[0.04,0.12], tips: "Slow drilling, pecking recommended."},
          aluminum:   {vc:[120,220],f:[0.10,0.30], tips: "High rpm ok, ensure chips clear."},
          brass:      {vc:[80,160], f:[0.08,0.20], tips: "Brass drills - watch for galling."},
          plastic:    {vc:[80,160], f:[0.10,0.30], tips: "Low heat; use backing material."},
          SuperAlloy:    {vc:[20,40],  f:[0.03,0.08], tips: "Very slow, use pecking and coolant."}
        },
        hss: {
          mild_steel: {vc:[25,40], f:[0.06,0.18], tips: "HSS drills require slower speeds."}
        }
      },
      slot: {
        carbide: {
          mild_steel: {vc:[90,160], fz:[0.02,0.05], tips: "Slotting increases heat - reduce fz."},
          aluminum:   {vc:[250,380], fz:[0.03,0.10], tips: "High speeds, ensure chip clearance."},
          SuperAlloy:    {vc:[18,30], fz:[0.01,0.03], tips: "Ramp/micro-ops recommended."}
        }
      }
    };

    // elements
    const modeButtons = Array.from(document.querySelectorAll('.mode-btn'));
    const toolMatEl = document.getElementById('toolMat');
    const workMatEl = document.getElementById('workMat');
    const VcEl = document.getElementById('Vc');
    const vcRangeEl = document.getElementById('vcRange');
    const DEl = document.getElementById('D');
    const nEl = document.getElementById('n');
    const VfEl = document.getElementById('Vf');
    const fzEl = document.getElementById('fz');
    const fzLabel = document.getElementById('fzLabel');
    const fzRangeEl = document.getElementById('fzRange');
    const ZEl = document.getElementById('Z');
    const calcBtn = document.getElementById('calcBtn');
    const suggestBtn = document.getElementById('suggestBtn');
    const resetBtn = document.getElementById('resetBtn');
    const outN = document.getElementById('outN');
    const outVf = document.getElementById('outVf');
    const formulaUsedEl = document.querySelector('.formula');
    const calcMsgEl = document.getElementById('calcMsg');
    const advTipsEl = document.getElementById('advTips');
    const modeTitleEl = document.getElementById('modeTitle');
    const modeSubEl = document.getElementById('modeSub');
    const modeIconEl = document.getElementById('modeIcon');
    const copyResBtn = document.getElementById('copyRes');
    const exportCsvBtn = document.getElementById('exportCsv');

    let currentMode = 'endmill';
    let lastResult = null;

    // mode handling
    function setMode(mode){
      currentMode = mode;
      modeButtons.forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
      if(mode === 'drill'){
        fzLabel.textContent = 'Feed per Revolution f (mm/rev)';
        document.getElementById('zWrap').style.display = 'none';
        modeTitleEl.textContent = 'Drill';
        modeSubEl.textContent = 'Feed per revolution (f) used';
        modeIconEl.innerHTML = '<i class="fa-solid fa-drill"></i>';
      } else if(mode === 'slot'){
        fzLabel.textContent = 'Feed per Tooth fz (mm/tooth)';
        document.getElementById('zWrap').style.display = '';
        modeTitleEl.textContent = 'Slotmill';
        modeSubEl.textContent = 'Conservative chipload for slotting';
        modeIconEl.innerHTML = '<i class="fa-solid fa-slash"></i>';
      } else {
        fzLabel.textContent = 'Feed per Tooth fz (mm/tooth)';
        document.getElementById('zWrap').style.display = '';
        modeTitleEl.textContent = 'Endmill';
        modeSubEl.textContent = 'fz × Z used for feed';
        modeIconEl.innerHTML = '<i class="fa-solid fa-cut"></i>';
      }
      updateVcSuggestion();
    }

    modeButtons.forEach(b=> b.addEventListener('click', ()=> setMode(b.dataset.mode)));

    // robust preset lookup with fallbacks
    function getPresetRange(mode, toolMat, workMat){
      // try exact match
      if(presets[mode] && presets[mode][toolMat] && presets[mode][toolMat][workMat]){
        return JSON.parse(JSON.stringify(presets[mode][toolMat][workMat])); // deep copy
      }

      // fallback 1: same material but carbide tool
      if(presets[mode] && presets[mode]['carbide'] && presets[mode]['carbide'][workMat]){
        const p = JSON.parse(JSON.stringify(presets[mode]['carbide'][workMat]));
        // if user selected coated, adjust vc +10%
        if(toolMat === 'coated' && p.vc) p.vc = [Math.round(p.vc[0]*1.1), Math.round(p.vc[1]*1.1)];
        // if user selected hss but no hss entry, reduce vc approx 60%
        if(toolMat === 'hss' && p.vc) p.vc = [Math.round(p.vc[0]*0.6), Math.round(p.vc[1]*0.6)];
        return p;
      }

      // fallback 2: use endmill carbide same material
      if(presets.endmill && presets.endmill.carbide && presets.endmill.carbide[workMat]){
        const p = JSON.parse(JSON.stringify(presets.endmill.carbide[workMat]));
        if(toolMat === 'coated' && p.vc) p.vc = [Math.round(p.vc[0]*1.1), Math.round(p.vc[1]*1.1)];
        if(toolMat === 'hss' && p.vc) p.vc = [Math.round(p.vc[0]*0.6), Math.round(p.vc[1]*0.6)];
        return p;
      }

      // fallback 3: generic default conservative
      return {vc:[60,120], fz:[0.02,0.05], tips: "No exact preset — use conservative values and test."};
    }

    function updateVcSuggestion(){
      const tm = toolMatEl.value;
      const wm = workMatEl.value;
      const preset = getPresetRange(currentMode, tm, wm);
      if(preset){
        const vcRange = preset.vc;
        const fzRange = preset.fz || preset.f;
        const minVc = Math.round(vcRange[0]);
        const maxVc = Math.round(vcRange[1]);
        const mid = Math.round((minVc + maxVc)/2);
        // auto-fill only if empty
        if(!VcEl.value) VcEl.value = mid;
        vcRangeEl.textContent = `Suggested Vc range: ${minVc} – ${maxVc} m/min`;
        if(fzRange){
          if(currentMode === 'drill'){
            fzRangeEl.textContent = `Suggested feed per rev: ${fzRange[0].toFixed(3)} – ${fzRange[1].toFixed(3)} mm/rev`;
          } else {
            fzRangeEl.textContent = `Suggested fz range: ${fzRange[0].toFixed(3)} – ${fzRange[1].toFixed(3)} mm/tooth`;
          }
        } else {
          fzRangeEl.textContent = '';
        }
        advTipsEl.textContent = preset.tips || '';
      } else {
        vcRangeEl.textContent = 'No preset available — enter Vc manually.';
        fzRangeEl.textContent = '';
        advTipsEl.textContent = '';
      }
    }

    // Suggest button — fills mid values
    suggestBtn.addEventListener('click', ()=>{
      const tm = toolMatEl.value;
      const wm = workMatEl.value;
      const preset = getPresetRange(currentMode, tm, wm);
      if(!preset){ alert('No preset available for this selection.'); return; }
      const vcRange = preset.vc;
      const midVc = Math.round((vcRange[0] + vcRange[1]) / 2);
      VcEl.value = midVc;
      if(currentMode === 'drill'){
        const f = preset.f || preset.fz || [0.06,0.12];
        fzEl.value = (f[0]).toFixed(3); // for drills it's f (mm/rev)
      } else {
        const fz = preset.fz || [0.02,0.04];
        fzEl.value = (fz[0]).toFixed(3);
        if(!ZEl.value) ZEl.value = 4;
      }
      updateVcSuggestion();
      flash(VcEl); flash(fzEl);
    });

    // calculation: same robust algorithm as before
    function calculate(){
      formulaUsedEl.querySelectorAll('div').forEach((d,i)=>{ if(i>0) d.remove(); });
      calcMsgEl.textContent = '';
      const Vc_input = parseFloatSafe(VcEl.value);
      const D = parseFloatSafe(DEl.value);
      let n = parseFloatSafe(nEl.value);
      let Vf = parseFloatSafe(VfEl.value);
      let fz = parseFloatSafe(fzEl.value);
      let Z = parseFloatSafe(ZEl.value);

      for(let i=0;i<6;i++){
        if(!isNaN(Vc_input) && !isNaN(D) && (isNaN(n) || n===null)) n = (Vc_input * 1000) / (PI * D);
        if(isNaN(Vc_input) && !isNaN(n) && !isNaN(D)) {/* not used here but kept for consistency */ }
        if(currentMode === 'drill'){
          if(!isNaN(n) && !isNaN(fz) && isNaN(Vf)) Vf = n * fz;
          if(!isNaN(Vf) && !isNaN(n) && isNaN(fz)) fz = Vf / n;
        } else {
          if(!isNaN(n) && !isNaN(fz) && !isNaN(Z) && isNaN(Vf)) Vf = n * fz * Z;
          if(!isNaN(Vf) && !isNaN(n) && !isNaN(Z) && isNaN(fz)) fz = Vf / (n * Z);
          if(!isNaN(Vf) && !isNaN(n) && !isNaN(fz) && isNaN(Z)) Z = Vf / (n * fz);
        }
      }

      const nOut = (!isNaN(n) && isFinite(n)) ? Math.round(n) : null;
      const VfOut = (!isNaN(Vf) && isFinite(Vf)) ? Number(Vf.toFixed(1)) : null;
      const fzOut = (!isNaN(fz) && isFinite(fz)) ? Number(fz.toFixed(4)) : null;

      outN.textContent = nOut ? `${nOut} rpm` : '-';
      outVf.textContent = VfOut ? `${VfOut} mm/min` : '-';

      // formulas used display
      const used = [];
      if(!isNaN(Vc_input) && !isNaN(DEl.value)) used.push('n = (Vc × 1000) / (π × D)');
      if(currentMode === 'drill'){
        if(!isNaN(n) && !isNaN(fz) && isNaN(Vf)) used.push('Vf = n × f (f = mm/rev)');
        if(!isNaN(Vf) && !isNaN(n) && isNaN(fz)) used.push('f = Vf / n');
      } else {
        if(!isNaN(n) && !isNaN(fz) && !isNaN(Z) && isNaN(Vf)) used.push('Vf = n × fz × Z');
        if(!isNaN(Vf) && !isNaN(n) && !isNaN(Z) && isNaN(fz)) used.push('fz = Vf / (n × Z)');
      }

      // append formula lines to formula box (preserve top header)
      used.forEach(s => {
        const d = document.createElement('div');
        d.style.marginTop = '6px';
        d.textContent = s;
        formulaUsedEl.appendChild(d);
      });

      // warnings
      const msgs = [];
      if(fzOut && fzOut > 1) msgs.push(`fz (${fzOut}) seems very large — check units`);
      if(VfOut && VfOut > 60000) msgs.push(`Vf (${VfOut}) unusually large — check inputs`);
      if(msgs.length){ calcMsgEl.textContent = msgs.join('  •  '); calcMsgEl.className = 'warn'; }
      else { calcMsgEl.textContent = 'Calculation OK — treat results as starting suggestions.'; calcMsgEl.className = 'ok'; }

      lastResult = {mode: currentMode, Vc: Vc_input||null, D: DEl.value||null, n: nOut, Vf: VfOut, fz: fzOut, Z: Z||null};
    }

    // helpers
    function parseFloatSafe(v){
      if(v===undefined||v===null) return NaN;
      const s = String(v).trim();
      if(s === '') return NaN;
      try {
        if(/^[0-9+\-*/().\s]+$/.test(s)) return Function('"use strict";return (' + s + ')')();
      } catch(e){}
      return NaN;
    }
    function flash(el){
      if(!el) return;
      const prev = el.style.boxShadow;
      el.style.boxShadow = '0 8px 28px rgba(43,154,224,0.12)';
      setTimeout(()=> el.style.boxShadow = prev || '', 300);
    }

    // copy/export
    copyResBtn.addEventListener('click', ()=>{
      if(!lastResult){ alert('No result to copy'); return; }
      navigator.clipboard?.writeText(JSON.stringify(lastResult, null, 2)).then(()=> alert('Result copied')).catch(()=> alert('Copy failed'));
    });
    exportCsvBtn.addEventListener('click', ()=>{
      if(!lastResult){ alert('No result to export'); return; }
      const rows = [['mode','Vc(m/min)','D(mm)','n(rpm)','Vf(mm/min)','fz(mm/tooth or mm/rev)','Z'], [lastResult.mode, lastResult.Vc || '', lastResult.D || '', lastResult.n || '', lastResult.Vf || '', lastResult.fz || '', lastResult.Z || '']];
      const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'milling_v4_4_result.csv'; a.click(); URL.revokeObjectURL(url);
    });

    // reset
    resetBtn.addEventListener('click', ()=>{
      [VcEl, DEl, nEl, VfEl, fzEl, ZEl].forEach(i=> i.value = '');
      outN.textContent = '- rpm'; outVf.textContent = '- mm/min';
      calcMsgEl.textContent = 'Awaiting input...'; formulaUsedEl.querySelectorAll('div').forEach((d,i)=>{ if(i>0) d.remove(); });
      advTipsEl.textContent = ''; lastResult = null; updateVcSuggestion();
    });

    // events
    toolMatEl.addEventListener('change', updateVcSuggestion);
    workMatEl.addEventListener('change', updateVcSuggestion);
    calcBtn.addEventListener('click', calculate);
    VcEl.addEventListener('keydown', e=> { if(e.key==='Enter') calculate(); });
    DEl.addEventListener('keydown', e=> { if(e.key==='Enter') calculate(); });
    nEl.addEventListener('keydown', e=> { if(e.key==='Enter') calculate(); });
    VfEl.addEventListener('keydown', e=> { if(e.key==='Enter') calculate(); });
    fzEl.addEventListener('keydown', e=> { if(e.key==='Enter') calculate(); });
    ZEl.addEventListener('keydown', e=> { if(e.key==='Enter') calculate(); });

    // initial
    (function init(){
      setMode('endmill');
      toolMatEl.value = 'carbide';
      workMatEl.value = 'mild_steel';
      updateVcSuggestion();
    })();

  </script>
</body>
</html>

